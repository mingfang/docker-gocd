<h3><%= l.string('ARTIFACTS') -%></h3>
<span class="contextual_help has_go_tip_right" title="<%= l.string("INSTRUCTION_ARTIFACTS") -%>">&nbsp;</span>
<% form_for :job, @job,
                :url => admin_job_update_path(:current_tab => "artifacts"),
                :html => {:method => :put,
                          :id => "job_edit_form",
                          :onsubmit => "return AjaxForm.jquery_ajax_submit(this, AjaxForm.ConfigFormEditHandler);",
                          :class => "popup_form"} do |f| %>
    <%= md5_field %>
    <%= register_defaultable_list("job>artifactPlans") %>

    <div class="fieldset">
        <% scope = {:form => f, :collection => @job.artifactPlans()}; -%><div class="form_content">
    <div class="artifacts_plan_section popup_form">
        <textarea id="artifact_template" class="template">
            <%- scope[:form].fields_for :artifactPlans, :index => "" do |var_form| -%>
                <td class="name_value_cell">
                    <%= var_form.text_field :src, :class => "form_input artifact_source", :omit_id_generation => true -%>
                </td>
                <td class="name_value_cell">
                    <%= var_form.text_field :dest, :class => "form_input artifact_destination", :omit_id_generation => true -%>
                </td>
                <td class="name_value_cell">
                    <%= var_form.select "artifactTypeValue",  ["Build Artifact", "Test Artifact"], {}, :class => "small" -%>
                </td>
                <td class="name_value_cell">
                    <span class="icon_remove delete_parent"></span>
                </td>
            <%- end -%>
        </textarea>

        <table class="artifact">
            <thead>
            <tr >
                <th><h4 class="src"><%= l.string("SOURCE") -%></h4>
                    <span class="contextual_help has_go_tip_right" title="<%=l.string("TOOLTIP_ARTIFACT_SOURCE")-%>"></span>
                </th>
                <th><h4 class="dest"><%= l.string("DESTINATION") -%></h4>
                    <span class="contextual_help has_go_tip_right" title="<%= l.string("TOOLTIP_ARTIFACT_DESTINATION") -%>"></span>
                </th>
                <th><h4 class="type" ><%= l.string("INSTRUCTION_TEST_ARTIFACT") %></h4>
                    <span class="contextual_help has_go_tip_right" title="<%= l.string("TOOLTIP_TEST_ARTIFACT") -%>"></span>
                </th>
                <th>&nbsp;</th>
            </tr>
            </thead>
            <tbody class="artifact">
            <% scope[:collection].each do |variable| -%>
                <%- scope[:form].fields_for com.thoughtworks.cruise.config.JobConfig::ARTIFACT_PLANS, variable, :index => "" do |var_form| -%>
                    <tr>
                        <td class="name_value_cell">
                            <%= var_form.text_field com.thoughtworks.cruise.config.ArtifactPlan::SRC, :class => "form_input artifact_source", :omit_id_generation => true-%>
                            <%= error_message_on(variable, com.thoughtworks.cruise.config.ArtifactPlan::SRC, :css_class => "form_error") %>
                        </td>
                        <td class="name_value_cell">
                            <%= var_form.text_field com.thoughtworks.cruise.config.ArtifactPlan::DEST, :class => "form_input artifact_destination", :omit_id_generation => true-%>
                            <%= error_message_on(variable, com.thoughtworks.cruise.config.ArtifactPlan::DEST, :css_class => "form_error") %>
                        </td>
                        <td class="name_value_cell">
                            <%= var_form.select "artifactTypeValue",  ["Build Artifact", "Test Artifact"], {}, :class => "small"  %>
                        </td>
                        <td class="name_value_cell">
                            <span class="icon_remove delete_parent"></span>
                        </td>
                    </tr>
                <%- end -%>
            <%- end -%>
            </tbody>
        </table>
		<%= action_icon({:type => "add", :text => l.string("ADD"), :href => "#", :class => "skip_dirty_stop", :id => "add_artifact"}) %>
    </div>
    <div class="clear"></div>
</div>
<script type="text/javascript">
    Util.on_load(function() {
        function setupVarForm(finish_button) {
            var rowCreator = new EnvironmentVariables.RowCreator(jQuery('#artifact_template'), 'tr', '.delete_parent');
            var variables = new EnvironmentVariables(
                    jQuery('tbody.artifact'),
                    rowCreator,
                    null,
                    function(inputs) {
                        inputs.dirty_form();
                    },
                    function(row) {
                        row.parents("form.dirtyform").data("dirty", true);
                    });

            variables.registerAddButton(jQuery("#add_artifact"))
            variables.addDefaultRow();
            variables.registerFinishButton(finish_button);
        }

        var finish_button = jQuery(".finish");
        setupVarForm(finish_button);
    });
</script>
    </div>

    <% scope = {}; -%><script type="text/javascript">
    Util.on_load(function() {
        jQuery(".has_go_tip").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10});
        jQuery(".has_go_tip_right").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10, defaultPosition: "right"});
        jQuery(".has_go_tip_left").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10, defaultPosition: "left" });
        jQuery(".has_go_tip_top").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10, defaultPosition: "top" });
    });
</script>
    <% scope = {:reset_url => admin_job_edit_path(:pipeline_name => @pipeline.name(), :stage_name => params[:stage_name], :job_name => params[:job_name], :current_tab => "artifacts")}; -%><div class="form_buttons">
    <%= submit_button(l.string("SAVE"), :class => 'primary skip_dirty_stop') %>
    <%= link_to  l.string("RESET"), scope[:reset_url], :class => 'reset_button link_as_button skip_dirty_stop', :id => 'reset_form' -%>
</div>
<% end %>
<script type="text/javascript">
   AjaxForm.error_box_selector = '#form_parent';
</script>