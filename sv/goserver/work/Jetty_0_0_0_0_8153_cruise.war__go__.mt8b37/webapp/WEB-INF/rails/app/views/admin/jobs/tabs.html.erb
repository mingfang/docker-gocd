<h3><%= l.string("TABS") %></h3>
<span title="<%= l.string("TOOLTIP_TABS") -%>" class="contextual_help has_go_tip_right">&nbsp;</span>
<% form_for :job, @job,
                :url => admin_job_update_path(:current_tab => "tabs"),
                :html => {:method => :put,
                          :id => "job_edit_form",
                          :onsubmit => "return AjaxForm.jquery_ajax_submit(this, AjaxForm.ConfigFormEditHandler);",
                          :class => "popup_form"} do |f| %>
    <div class="fieldset">
        <%= md5_field %>
        <%= current_tab_field("tabs") -%>
        <%= register_defaultable_list("job>tabs") %>
        <% scope = {:form => f, :collection => @job.getTabs(), :collection_name => :tabs}; -%><div class="form_content">
    <div class="job_tabs_section popup_form">
        <textarea id="<%= scope[:collection_name] -%>_template" class="template">
            <%- scope[:form].fields_for scope[:collection_name], :index => "" do |tab_form| -%>
                <td class="name_value_cell name">
                    <%= tab_form.text_field :name, :class => "form_input environment_variable_name", :omit_id_generation => true -%>
                </td>

                <td class="name_value_cell path">
                    <div>
                        <%= tab_form.text_field :path, :class => "form_input environment_variable_value", :omit_id_generation => true -%>
                    </div>
                </td>
                <td class="name_value_cell">
                    <span class="icon_remove delete_parent"></span>
                </td>
                
            <%- end -%>
        </textarea>
        <table class="<%= scope[:collection_name] -%>">
            <thead>
            <tr>
                <th><h4><%= l.string("TAB_NAME") -%></h4>
                    <span class="contextual_help has_go_tip_right" title="<%=l.string("TOOLTIP_TAB_NAME")-%>"></span>
                </th>
                <th class="path"><h4><%= l.string("PATH") -%></h4>
                    <span class="contextual_help has_go_tip_right" title="<%=l.string("TOOLTIP_TAB_PATH")-%>"></span>
                </th>
                <th></th>
            </tr>
            </thead>
            <tbody class="<%= scope[:collection_name] -%>">
            <% scope[:collection].each do |tab| -%>
                <%- scope[:form].fields_for scope[:collection_name], tab, :index => "" do |tab_form| -%>
                    <tr>
                        <td class="name_value_cell name">
                            <%= tab_form.text_field :name, :class => "form_input environment_variable_name", :omit_id_generation => true -%>
                            <%= error_message_on(tab, com.thoughtworks.cruise.config.Tab::NAME, :css_class => "name_value_error") %>
                            <%= hidden_field_tag "#{scope[:form].object_name}[#{scope[:collection_name]}][][original_name]", tab.getName() %>
                        </td>
                        <td class="name_value_cell path">
                            <div>
                                <%= tab_form.text_field :path, :class => "form_input environment_variable_value", :omit_id_generation => true -%>
                                <%= error_message_on(tab, com.thoughtworks.cruise.config.Tab::PATH, :css_class => "name_value_error") %>
                            </div>
                        </td>
                        <td class="name_value_cell">
                            <span class="icon_remove delete_parent"></span>
                        </td>
                    </tr>
                <%- end -%>
            <%- end -%>
            </tbody>
        </table>
		<%= action_icon({:type => "add", :text => l.string("ADD"), :href => "#", :id => id="add_#{scope[:collection_name]}", :class => "skip_dirty_stop"}) %>
        <div class="clear"></div>
    </div>
</div>
<script type="text/javascript">
    Util.on_load(function() {
        function setupVarForm(finish_button) {
            var rowCreator = new EnvironmentVariables.RowCreator(jQuery('#<%=scope[:collection_name]-%>_template'), 'tr', '.delete_parent');
            var variables = new EnvironmentVariables(
                    jQuery('tbody.<%=scope[:collection_name]-%>'),
                    rowCreator,
                    null,
                    function(inputs) {
                        inputs.dirty_form();
                    },
                    function(row) {
                        row.parents("form.dirtyform").data("dirty", true);
                    });

            variables.registerAddButton(jQuery("#add_<%=scope[:collection_name]-%>"))
            variables.addDefaultRow();
            variables.registerFinishButton(finish_button);
        }

        var finish_button = jQuery(".finish");
        setupVarForm(finish_button);
    });
</script>
    </div>
    <% scope = {}; -%><script type="text/javascript">
    Util.on_load(function() {
        jQuery(".has_go_tip").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10});
        jQuery(".has_go_tip_right").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10, defaultPosition: "right"});
        jQuery(".has_go_tip_left").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10, defaultPosition: "left" });
        jQuery(".has_go_tip_top").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10, defaultPosition: "top" });
    });
</script>
    <% scope = {:reset_url => admin_job_edit_path(:pipeline_name => @pipeline.name(), :stage_name => params[:stage_name], :job_name => params[:job_name], :current_tab => "tabs")}; -%><div class="form_buttons">
    <%= submit_button(l.string("SAVE"), :class => 'primary skip_dirty_stop') %>
    <%= link_to  l.string("RESET"), scope[:reset_url], :class => 'reset_button link_as_button skip_dirty_stop', :id => 'reset_form' -%>
</div>
<% end %>
<script type="text/javascript">
        AjaxForm.error_box_selector = '#form_parent';
</script>