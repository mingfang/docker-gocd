<% scope = {:submit_label => l.string("SAVE"), :material => @material, :url => admin_dependency_create_path, :method => "POST"}; -%><%= render(:partial => "shared/flash_message") %>
<% _scope = {}; -%><% if @config_file_conflict -%>
    <div id="config_save_actions" class="flash">
        <button id="reload_config" class="reload_config primary"><%=l.string("RELOAD")-%></button>
        <label class="inline"><%=l.string("REFRESH_CONFIG")%></label>
    </div>
    <script type="text/javascript">
        Util.on_load(function() {
           jQuery("#reload_config").click(function() {
               var location = "<%= request.referer -%>";
               if (location.endsWith("#")) {
                   location = location.substring(0, location.length - 1);
               }
               window.location.href = location;
           });
        });
    </script>
<% end -%>
<% form_for(:material, scope[:material],
            :url => scope[:url],
            :html => {:method => scope[:method],
                      :onsubmit => "return AjaxForm.jquery_ajax_submit(this);",
                      :class => "popup_form"}) do |f| %>
    <%= md5_field %>
    <%= current_tab_field("materials") -%>
    <div class="form_content change_materials">
        <% _scope = {}; -%><% if @errors && !@errors.empty? %>
    <div class="form_submit_errors">
        <div class="errors">
            <h3><%= l.string("GLOBAL_ERRORS_MESSAGE") -%></h3>
            <ul>
                <% @errors.each do |error| %>
                    <li class="error"><%= h(error.to_s) -%></li>
                <% end %>
            </ul>
        </div>
    </div>
<% end %>
        <div class="fieldset">
            <div class="form_item">
                <div class="form_item_block">
                    <label><%= l.string('MATERIAL_NAME') -%></label>
                    <%= f.text_field com.thoughtworks.cruise.config.materials.AbstractMaterialConfig::MATERIAL_NAME, :class => "form_input", :omit_id_generation => true -%>
                    <%= error_message_on(scope[:material], com.thoughtworks.cruise.config.materials.AbstractMaterialConfig::MATERIAL_NAME, :css_class => "form_error") %>
                </div>
                <div class="form_item_block required">
                    <label><%= l.string('PIPELINE') -%> <span class="autocomplete_stage">[<%= l.string('STAGE') -%>]</span><span class="asterisk"><%= l.string("REQUIRED_FIELD") -%></span></label>
                    <%= f.text_field com.thoughtworks.cruise.config.materials.dependency.DependencyMaterialConfig::PIPELINE_STAGE_NAME, :class => "form_input" -%>
                    <%= error_message_on(scope[:material], com.thoughtworks.cruise.config.materials.dependency.DependencyMaterialConfig::PIPELINE_STAGE_NAME, :css_class => "form_error") %>
                    <div class="autocomplete"></div>
                </div>
            </div>
            <% _scope = {}; -%><p class="required">
	<span class="asterisk"><%= l.string("REQUIRED_FIELD")%></span><%= l.string("REQUIRED_FIELD_MESSAGE")-%>
</p>

        </div>
    </div>
    <% _scope = {:pipeline_stages_json => @pipeline_stages_json, :selector => "#material_pipelineStageName"}; -%><script type="text/javascript">
    var pipelines = <%= _scope[:pipeline_stages_json]-%>;

    jQuery("<%= _scope[:selector] -%>").autocomplete(pipelines, {
        minChars: 0,
        width: 400,
        matchContains: "word",
        autoFill: false,
        formatItem: function(row, i, max) {
            return  row.pipeline + " <span class='autocomplete_stage'>[" + row.stage + "]</span>";
        },
        formatMatch: function(row, i, max) {
            return row.pipeline + " " + row.stage;
        },
        formatResult: function(row) {
            return row.pipeline + " [" + row.stage + "]";
        }
    });

</script>
    <% _scope = {:submit_label => scope[:submit_label]}; -%><div class="form_buttons actions">
    <%= submit_button(_scope[:submit_label], :class => 'primary finish') %>
    <button class="left submit close_modalbox_control"><span><%= l.string('CANCEL') -%></span></button>
</div>
<% end %>
