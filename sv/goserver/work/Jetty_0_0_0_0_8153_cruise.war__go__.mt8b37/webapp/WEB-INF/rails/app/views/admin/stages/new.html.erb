<div id="new_stage_container">
    <%= render(:partial => "shared/flash_message") %>
    <% scope = {}; -%><% if @config_file_conflict -%>
    <div id="config_save_actions" class="flash">
        <button id="reload_config" class="reload_config primary"><%=l.string("RELOAD")-%></button>
        <label class="inline"><%=l.string("REFRESH_CONFIG")%></label>
    </div>
    <script type="text/javascript">
        Util.on_load(function() {
           jQuery("#reload_config").click(function() {
               var location = "<%= request.referer -%>";
               if (location.endsWith("#")) {
                   location = location.substring(0, location.length - 1);
               }
               window.location.href = location;
           });
        });
    </script>
<% end -%>
    <% form_for(:stage, @stage,
                :url => admin_stage_create_path,
                :html => {:method => "POST",
                          :onsubmit => "return AjaxForm.jquery_ajax_submit(this);",
                          :class => "popup_form"}) do |f| %>
        <%= md5_field %>
        <input type="hidden" name="current_tab" value="stages" />

        <div class="form_content">
            <% scope = {}; -%><% if @errors && !@errors.empty? %>
    <div class="form_submit_errors">
        <div class="errors">
            <h3><%= l.string("GLOBAL_ERRORS_MESSAGE") -%></h3>
            <ul>
                <% @errors.each do |error| %>
                    <li class="error"><%= h(error.to_s) -%></li>
                <% end %>
            </ul>
        </div>
    </div>
<% end %>
            <h3><%= l.string("STAGE_INFORMATION") -%></h3>

            <div class="fieldset">
                <div class="form_item required">
                    <%= label_tag stage_name_id = random_dom_id("stage_name_"), required_label_text(l.string('STAGE_NAME')) %>
                    <%= f.text_field com.thoughtworks.cruise.config.StageConfig::NAME, :class => "form_input", :id => stage_name_id -%>
                    <%= error_message_on(@stage, "name", :css_class => "form_error") %>
                </div>
                <div class="form_item checkbox_row">
                    <label><%= l.string('STAGE_TRIGGER_TYPE:') -%></label>
                    <span class="stage_approval contextual_help has_go_tip_right" title="<%= l.string("RADIO_BUTTON_TITLE_APPROVAL") -%>">&nbsp;</span>
                    <% f.fields_for com.thoughtworks.cruise.config.StageConfig::APPROVAL, @stage.approval do |approval| %>
                        <div class="checkbox_row">
                            <%= approval.radio_button com.thoughtworks.cruise.config.Approval::TYPE, com.thoughtworks.cruise.config.Approval::SUCCESS, :id => "auto" %>
                            <label for="auto"><%= l.string('AUTO') -%></label>
                        </div>

                        <div class="checkbox_row">
                            <%= approval.radio_button com.thoughtworks.cruise.config.Approval::TYPE, com.thoughtworks.cruise.config.Approval::MANUAL, :id => "manual" %>
                            <label for="manual"><%= l.string('MANUAL') -%></label>
                        </div>


                        <%= error_message_on(@stage.getApproval(), "type", :css_class => "form_error") %>

                    <% end %>
                </div>
                <p class="required">
	<span class="asterisk"><%= l.string("REQUIRED_FIELD")%></span><%= l.string("REQUIRED_FIELD_MESSAGE")-%>
</p>
            </div>

            <h3><%= l.string('INITIAL_JOB_AND_TASK') -%></h3>

            <div class="instructions"><%= l.string('INSTRUCTION_JOB_AND_TASK') -%></div>
            <div class="fieldset has_nested_fieldset">
                <% @stage.getJobs().each do |job| -%>
                    <%- f.fields_for com.thoughtworks.cruise.config.StageConfig::JOBS, job, :index => "" do |job_form| -%>
                        <div class="form_item required">
                            <%= label_tag job_name_id = random_dom_id("job_name_"), required_label_text(l.string('JOB_NAME')) %>
                            <%= job_form.text_field(com.thoughtworks.cruise.config.JobConfig::NAME, :id => job_name_id) %>
                            <%= error_message_on(job, com.thoughtworks.cruise.config.JobConfig::NAME, :css_class => "form_error") %>
                        </div>
                        <% scope = { :job => job, :job_form => job_form}; -%><div class="form_item_block">
    <% tasks = scope[:job].getTasks()%>
    
    <% scope[:job_form].fields_for com.thoughtworks.cruise.config.JobConfig::TASKS, tasks do |tasks_form| %>
        <div class="fieldset">
            <div class="form_item required">
                <%= label_tag random_dom_id('task_type_'), l.string("TASK_TYPE")+"<span class=\"asterisk\">*</span>" %>
                <%= tasks_form.select(com.thoughtworks.cruise.config.Tasks::TASK_OPTIONS, task_options, {:selected => tasks.getTaskOptions()}, {:class => "task_type", :id => "job_task_options"}) %>
            </div>
            <div id="job_tasks">
                <% @task_view_models.each do |tvm|
                   taskk = tvm.getModel()
                   task_class_name = taskk.java_class.simple_name
                   next if task_class_name == "FetchTask"
                %>
                    <div class="hidden task_entry <%=task_class_name-%>">
                        <% tasks_form.fields_for task_class_name, taskk do |task_form| %>
                            <%= render_pluggable_form_template(task_view_service.getViewModel(taskk, 'new'), form_name_provider(task_form), { :scope => {:task => taskk, :form => task_form, :hide_runif => scope[:hide_runif]}}) -%>
                        <% end %>
                    </div>
                <% end %>
            </div>
        </div>

    <% end %>
    <script type="text/javascript">
        Util.on_load(function() {
            new TaskEditor.TypeEditor({container: jQuery('#job_tasks'), switch_control: jQuery('#job_task_options'), entry_to_be_hidden: '.task_entry'});
        });
    </script>
</div>

                    <%- end -%>
                <%- end -%>
            </div>
        </div>
        <% scope = {}; -%><script type="text/javascript">
    Util.on_load(function() {
        jQuery(".has_go_tip").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10});
        jQuery(".has_go_tip_right").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10, defaultPosition: "right"});
        jQuery(".has_go_tip_left").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10, defaultPosition: "left" });
        jQuery(".has_go_tip_top").tipTip({activation: "click", maxWidth: "auto", edgeOffset: 10, defaultPosition: "top" });
    });
</script>
        <% scope = {:submit_label => "SAVE"}; -%><div class="form_buttons actions">
    <%= submit_button(scope[:submit_label], :class => 'primary finish') %>
    <button class="left submit close_modalbox_control"><span><%= l.string('CANCEL') -%></span></button>
</div>
    <% end %>
</div>