<div class="on_cancel fieldset">
    <%= scope[:form].check_box(com.thoughtworks.cruise.config.AbstractTask::HAS_CANCEL_TASK, :class => "has_cancel_task", :id => "has_cancel_task") -%>
    <%= label_tag :has_cancel_task, l.string("ON_CANCEL_TASK"), :class => "inline" -%>
    <div class="on_cancel_task <%= scope[:task].hasCancelTask() ? '' : 'hidden' %>">
        <% scope[:form].fields_for com.thoughtworks.cruise.config.AbstractTask::ON_CANCEL_CONFIG, scope[:task].onCancelConfig do |on_cancel_config| %>
            <%= on_cancel_config.select(com.thoughtworks.cruise.config.OnCancelConfig::ON_CANCEL_OPTIONS, task_options, {:selected => selected_option(scope[:task].onCancelConfig())}, {:class => "on_cancel_type", :id => "on_cancel_task_options"}) %>
            <% tasks = com.thoughtworks.cruise.config.Tasks.new() %>
            <% @on_cancel_task_vms.each do |oncancel_task_vm|
                oncancel_task = oncancel_task_vm.getModel()
                task_class_name = oncancel_task.java_class.simple_name
                next if task_class_name == "FetchTask"
            %>
                <div class="hidden task_entry <%= task_class_name -%>">
                    <% on_cancel_config.fields_for oncancel_task.getTaskSimpleName() + "OnCancel", oncancel_task do |task_form| %>
                        <%= render_pluggable_form_template(oncancel_task_vm, form_name_provider(task_form), {:scope => {:form => task_form, :task => oncancel_task}}) -%>
                    <% end %>
                </div>
            <% end %>
        <% end %>
    </div>
</div>

<script type="text/javascript">
    Util.on_load(function() {
        var helper = new TaskEditor.TypeEditor({container: jQuery('.on_cancel_task'), switch_control: jQuery('.on_cancel_type'), entry_to_be_hidden: '.task_entry'});
        helper.showHideCheckbox(jQuery('.has_cancel_task'));//memory leak
    });
</script>