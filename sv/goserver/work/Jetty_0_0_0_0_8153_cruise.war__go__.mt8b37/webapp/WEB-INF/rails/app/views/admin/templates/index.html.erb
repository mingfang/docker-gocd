<%- @tab_name = 'templates' -%>
<%- @current_tab_name = "admin" -%>
<%- @view_title = l.string("ADMINISTRATION") -%>

<div class="templates">
    <h1>
        Pipeline Templates
		<span class="title_secondary_info">
            <%- if is_user_a_template_admin? && !is_user_an_admin? -%>
                <span class="add_icon_disabled" title="<%= l.string("UNAUTHORIZED_TO_CREATE_TEMPLATE") -%>">
                    <%= l.string("ADD_NEW_TEMPLATE") -%>
                </span>
            <%- else -%>
                <a href="#" class="add_link" onclick="Modalbox.show('<%= template_new_path(:allow_pipeline_selection => true) -%>', {overlayClose: false,title: '<%= l.string("ADD_NEW_TEMPLATE") -%>'})">
                      <%= l.string("ADD_NEW_TEMPLATE") -%>
                </a>
            <%- end -%>
		</span>

    </h1>



    <% if @template_to_pipelines.size() == 0 %>
        <div class="information"><%= l.string("NO_TEMPLATES_DEFINED") %></div>
    <% else %>
        <% scope = {:template_to_pipelines => @template_to_pipelines}; -%><% scope[:template_to_pipelines].each do |template, pipelines| %>
    <% is_pipeline_empty = pipelines.isEmpty() -%>
    <div class="template" id="template_container_<%= template %>">

        <div class="template_group">
            <h2 class="group_name entity_title">
                <%= word_breaker(template, 75) %>
            </h2>

            <div class="title_action_wrapper">
                <ul>
                    <li>
                        <%= action_icon({:type => "edit", :text => l.string("EDIT"), :href => template_edit_path(:stage_parent => "templates", :pipeline_name => template, :current_tab => "general")}) %>
                    </li>
                    <li>
                        <%- if is_user_a_template_admin? && !is_user_an_admin? -%>
                            <%= action_icon({:type => "lock", :text => l.string("PERMISSIONS"), :title => l.string("UNAUTHORIZED_TO_EDIT_PERMISSIONS_FOR_TEMPLATE"), :disabled => true}) %>
                        <%- else -%>
                            <%= action_icon({:type => "lock", :text => l.string("PERMISSIONS"), :href => edit_template_permissions_path(:template_name => template)}) %>
                        <%- end -%>
                    </li>
                    <li>
                        <%- if is_user_a_template_admin? && !is_user_an_admin? -%>
                            <%= action_icon({:type => "delete", :text => l.string("DELETE"), :title => l.string("UNAUTHORIZED_TO_DELETE_TEMPLATE"), :disabled => true}) %>
                        <%- elsif !is_pipeline_empty -%>
                            <%= action_icon({:type => "delete", :text => l.string("DELETE"), :title => l.string("CANNOT_DELETE_TEMPLATE"), :disabled => true}) %>
                        <%- else -%>
                            <%= form_tag(delete_template_path(:pipeline_name => template), :method => :delete, :id => "delete_template_#{template}") %>
                            <%= md5_field %>
                            <span class="delete_icon action_icon delete_parent" id="trigger_delete_<%= template %>" title="<%= l.string("DELETE_TEMPLATE") -%>">
                                <%= l.string("DELETE") -%>
                                <% _scope = {:button_id => "trigger_delete_#{template}", :message => "Are you sure you want to delete the template '#{template}' ? ", :on_confirmation_js => "$('#{"delete_template_#{template}"}').submit()"}; -%><script type="text/javascript">
    <%- button_container = _scope[:button_container] -%>
    <%- button_id = _scope[:button_id] -%>
    <%- button_selector =  button_container==nil ? button_id : button_container+' #'+button_id -%>
    <%- prompt_selector =  button_container==nil ? button_id +' #warning_prompt' : button_container +' #warning_prompt' -%>
    <%- message = _scope[:message] -%>
    <%- on_confirmation_js = _scope[:on_confirmation_js] -%>
    jQuery(Util.escapeDotsFromId('<%=button_selector-%>')).click(function() {
        Modalbox.show(jQuery(Util.escapeDotsFromId('<%=prompt_selector-%>'))[0], {overlayClose: false, title: '<%= l.string("CONFIRM_DELETION") %>'});
    });
</script>
<div id="warning_prompt" class="warning" style="display:none;">
    <div class="ui-dialog-content">
        <p><%=message-%></p>
    </div>
    <div class="form_buttons actions">
        <%= submit_button(l.string("PROCEED"), :class=> "primary", :onclick => on_confirmation_js ) %>
        <%= submit_button(l.string("CANCEL"), :onclick => "Modalbox.hide()", :type => "button") %>
    </div>
</div>
                            </span>
                            <%= end_form_tag %>
                        <%- end -%>
                    </li>
                </ul>
            </div>
        </div>
        <div class="grouping_content_wrapper">

            <% if pipelines.isEmpty() %>
                <div class="information"><%= l.string("NO_PIPELINE_IN_TEMPLATE") %></div>
            <% else %>
                <table class="list_table">
                    <thead>
                    <tr class="pipeline">
                        <th class="name"><%= l.string("PIPELINE") %></th>
                        <th class="name"><%= l.string("ACTIONS") %></th>
                    </tr>
                    </thead>
                    <tbody>
                        <%- if is_user_a_template_admin? && !is_user_an_admin? -%>
                            <tr>
                                <td colspan="2">
                                    <span>
                                        <%= "This template is used in #{pipelines.length} #{pipelines.length > 1 ? "pipelines" : "pipeline"}." -%>
                                    </span>
                                </td>
                            </tr>
                        <%- else %>
                            <% pipelines.each do |pipeline| %>
                                <tr class="pipeline">
                                    <td class="name">
                                        <%= link_to pipeline, pipeline_edit_path(:pipeline_name => pipeline, :current_tab => "general") %>
                                    </td>
                                    <td>
                                        <%= action_icon({:type => "edit", :text => l.string("EDIT"), :href => pipeline_edit_path(:pipeline_name => pipeline, :current_tab => "general")}) %>
                                    </td>
                                </tr>
                            <% end %>
                        <% end %>
                    </tbody>
                </table>
            <% end %>
        </div>
    </div>
<% end %>
    <% end %>

</div>


<script type="text/javascript">
    AjaxForm.error_box_selector = '#MB_content';
</script>
