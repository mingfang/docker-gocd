<%= form_tag environment_update_path,
                    :method => "put",
                    :class => "popup_form",
                    :onsubmit => "return AjaxForm.jquery_ajax_submit(this);" %>
       <%= flash_message_pane_start("env_form_error_box", true) %>



<% scope = {:environment => @environment, :agents => @agents}; -%><div class="form_content">
    <div class="agents_section">
        <div class="agents_selection_table">
            <div class="input">
                <% if scope[:agents].empty? %>
                    <%= l.string("NO_AGENTS") %>
                <% else %>
                    <% _scope = {:agents => scope[:agents], :exclude_columns => ["status", "usable_space"], :sortable_columns => false, :show_only_disabled => true, :selector_name => 'environment[agents][][uuid]', :selected => scope[:environment].agents.map(&:uuid)}; -%><% _scope[:exclude_columns] ||= []
   _scope[:sortable_columns] = true if _scope[:sortable_columns].nil?
   _scope[:show_only_disabled] = false if _scope[:show_only_disabled].nil?
   _scope[:selector_name] ||= 'selected[]'
   _scope[:selected] ||= params[:selected]
   _scope[:agents] ||= @agents
%>

<script type="text/javascript">
Util.on_load(function() {
    jQuery("#select_all_agents").live('click',function() {
        var val = this.checked;
        jQuery(".agent_select").each(function() {
            this.checked = val;
        });
    });

    jQuery("input.agent_select").live("click", function() {
        var unchecked_check_boxes = jQuery("input.agent_select:not(:checked)");
        if(unchecked_check_boxes.length > 0) {
            jQuery("#select_all_agents").removeAttr("checked");
        }
    });
})

</script>


<table id='agent_details' class='agents list_table <%=" sortable_table" if _scope[:sortable_columns]%> selectable_table'>
    <thead>
    <tr class='agent_header'>
        <% if has_operate_permission_for_agents? %>
            <th class='selector'>
                <%= check_box_tag 'accept', '', false, {:id => 'select_all_agents', :class => 'agent_select'} -%>
            </th>
        <% end -%>

        <% unless _scope[:exclude_columns].include?('hostname') -%>
            <th class='hostname'><%= column_header("Agent Name",  "hostname", _scope[:sortable_columns]) %></th>
        <% end -%>

        <% unless _scope[:exclude_columns].include?('location') -%>
            <th class='location'><%= column_header("Sandbox", "location", _scope[:sortable_columns]) %></th>
        <% end -%>

        <% unless _scope[:exclude_columns].include?('operating_system') -%>
            <th class='operating_system'><%= column_header("OS", "operating_system", _scope[:sortable_columns]) %></th>
        <% end -%>

        <% unless _scope[:exclude_columns].include?('ip_address') -%>
            <th class='ip_address'><%= column_header("IP Address", "ip_address", _scope[:sortable_columns]) %></th>
        <% end -%>

        <% unless _scope[:exclude_columns].include?('status') -%>
            <th class='status'><%= column_header("Status", "status", _scope[:sortable_columns]) %></th>
        <% end -%>

        <% unless _scope[:exclude_columns].include?('usable_space') -%>
            <th class='usable_space'><%= column_header("Free Space", "usable_space", _scope[:sortable_columns]) %></th>
        <% end -%>

        <% unless _scope[:exclude_columns].include?('resources') -%>
            <th class='resources'><%= column_header("Resources", "resources", _scope[:sortable_columns]) %></th>
        <% end -%>

        <% unless _scope[:exclude_columns].include?('environments') -%>
            <th class='environments'><%= column_header("Environments", "environments", _scope[:sortable_columns]) %></th>
        <% end -%>
    </tr>
    </thead>
    <tbody>
    <% _scope[:agents].each do |agent_in_agent_table| %>
        <tr class='agent_instance <%= get_agent_status_class(_scope[:show_only_disabled],agent_in_agent_table.getStatus()) %>' id='<%= agent_in_agent_table.getUuid() %>'>
            <% agent_uuid = agent_in_agent_table.getUuid()-%>
            <% if has_operate_permission_for_agents? %>
                <%= agent_selector(agent_uuid, _scope[:selector_name], _scope[:selected]) %>
            <% end %>
            <% unless _scope[:exclude_columns].include?('hostname') -%>

                <%hostname = agent_in_agent_table.getHostname() -%>
                <% if agent_in_agent_table.getStatus().isRegistered() -%>
                    <%span_text = link_to(hostname, agent_detail_path(:uuid => agent_uuid)) -%>
                 <% else -%>
                    <%span_text = hostname -%>
                <% end -%>
                <td class='hostname' title='<%= hostname %>'>
                    <span class='agent_hostname'><%= span_text %></span>
                </td>

            <% end -%>

            <% unless _scope[:exclude_columns].include?('location') -%>
                <% display_value = smart_word_breaker(agent_in_agent_table.getLocation())%>
                <%= cell_with_title( display_value, 'location', agent_in_agent_table.getLocation()) %>
            <% end -%>

            <% unless _scope[:exclude_columns].include?('operating_system') -%>
                <%= cell_with_title( agent_in_agent_table.getOperatingSystem(), 'operating_system') %>
            <% end -%>

            <% unless _scope[:exclude_columns].include?('ip_address') -%>
                <%= cell_with_title( agent_in_agent_table.getIpAddress(), 'ip_address') %>
            <% end -%>

            <% unless _scope[:exclude_columns].include?('status') -%>
                <%= agent_status_cell(agent_in_agent_table) %>
            <% end -%>

            <% unless _scope[:exclude_columns].include?('usable_space') -%>
                <%= cell_with_title( agent_in_agent_table.freeDiskSpace(), 'usable_space') %>
            <% end -%>

            <% unless _scope[:exclude_columns].include?('resources') -%>
                <%= piped_cell(agent_in_agent_table.getResources(), l.string("NO_RESOURCES_SPECIFIED"), "resources") %>
            <% end -%>

            <% unless _scope[:exclude_columns].include?('environments') -%>
                <%= piped_cell(agent_in_agent_table.getEnvironments(), l.string("NO_ENVIRONMENTS_SPECIFIED"), "environments") %>
            <% end -%>


        </tr>
    <% end %>
    </tbody>
</table>
                <% end %>
            </div>
        </div>
    </div>
</div>


<%= config_md5_field %>
<%= register_defaultable_list("environment>agents") %>
    <% _scope = {:submit_label => "Save"}; -%><div class="form_buttons actions">
    <%= submit_button(_scope[:submit_label], :class => 'primary finish') %>
    <button class="left submit close_modalbox_control"><span><%= l.string('CANCEL') -%></span></button>
</div>
<%= end_form_tag %>
