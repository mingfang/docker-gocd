<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs
            title="<%=l.string('GADGET_NAME_PIPELINE_STATUS')%>"
            author="Go"
            author_email="support@thoughtworks.com"
            author_link="http://www.thoughtworks.com/products/go-continuous-delivery">
        <Require feature="oauthpopup"/>
        <Require feature="setprefs"/>
        <Require feature="dynamic-height" />
        <OAuth>
            <Service name="<%=l.string("GO")%>">
                <Request method="GET" url="<%= url_for(:controller => '/oauth_token', :action => :get_token, :only_path => false) %>"/>
                <Access method="GET" url="<%= url_for(:controller => '/oauth_token', :action => :get_token, :only_path => false) %>"/>
                <Authorization url="<%= url_for(:controller => '/oauth_authorize', :action => :index, :only_path => false) %>"/>
            </Service>
        </OAuth>
    </ModulePrefs>
    <UserPref name="pipelineName" datatype="string" default_value="" display_name="Pipeline Name" />
    <UserPref name="autoRefresh" datatype="bool" default_value="true" display_name="Enable Auto Refresh" />
    <Content type="html">
        <![CDATA[
            <% scope = {}; -%><!DOCTYPE html>

<% css_dir = File.join(File.dirname(__FILE__), "../../../../../stylesheets/") %>

<%= stylesheet_link_tag "structure/reset.css" %>

<!-- LEGACY Structure css, TODO: migrate these to structure/application.css and patterns -->
<%= stylesheet_link_tag "main", "layout", "structure", "ie_hacks" %>

<!-- END - LEGACY Structure css, TODO: migrate these to structure/application.css and patterns -->

<!-- Structure css -->

<%= stylesheet_link_tag "structure/application.css" %>
<% if use_compressed_js? %>
    <%= stylesheet_link_tag "plugins/plugins.css" %>
<% else %>
    <!-- Plugins css -->
    <%= stylesheet_link_tag "plugins/treeview.css",
                            "plugins/jquery.autocomplete.css"
    %>
<% end %>

<% if use_compressed_js? %>
    <%= stylesheet_link_tag "patterns/patterns.css" %>
<% else %>
    <!-- Patterns css -->
    <% styles =           [ "patterns/action_icons.css",
                            "patterns/buttons.css",
                            "patterns/dropdowns.css",
                            "patterns/forms.css",
                            "patterns/messages.css",
                            "patterns/modalbox.css",
                            "patterns/status_visualizations.css",
                            "patterns/tables.css",
                            "patterns/tabs.css",
                            "patterns/titles.css",
                            "patterns/tooltips.css",
                            "patterns/wizard_steps.css"]

        File.open(File.join(css_dir, 'patterns/all.css'), 'w') do |all_css|
            styles.each do |style|
              all_css.puts(File.read(File.join(css_dir, style)))
            end
        end
    %>
    <%= stylesheet_link_tag "patterns/all.css" %>
<% end %>


<!-- LEGACY Module pieces css, TODO: migrate these to patterns/plugins/views-->
<%= stylesheet_link_tag "module.css"%>
<!-- END - LEGACY Module pieces css, TODO: migrate these to patterns/plugins/views-->


<!-- Views css -->
<% if use_compressed_js? %>
    <%= stylesheet_link_tag "views/views.css" %>
<% else %>
    <% styles =           [ "views/admin_jobs.css",
                            "views/admin_materials.css",
                            "views/admin_materials_dependency.css",
                            "views/admin_materials_git.css",
                            "views/admin_materials_hg.css",
                            "views/admin_materials_p4.css",
                            "views/admin_materials_shared.css",
                            "views/admin_materials_svn.css",
                            "views/admin_pipeline_groups.css",
                            "views/admin_pipelines_snippet.css",
                            "views/admin_pipelines.css",
                            "views/admin_pipelines_materials.css",
                            "views/admin_shared.css",
                            "views/admin_stages.css",
                            "views/admin_tasks.css",
                            "views/admin_tasks_ant.css",
                            "views/admin_tasks_exec.css",
                            "views/admin_tasks_fetch.css",
                            "views/admin_tasks_nant.css",
                            "views/admin_tasks_rake.css",
                            "views/admin_tasks_shared.css",
                            "views/admin_templates.css",
                            "views/admin_user_roles.css",
                            "views/shared_go_license_about_to_expire.css",
                            "views/agents.css",
                            "views/backup.css",
                            "views/comparison.css",
                            "views/config_server.css",
                            "views/environments.css",
                            "views/failures.css",
                            "views/gadgets_pipeline.css",
                            "views/pipelines.css",
                            "views/server.css",
                            "views/shared.css",
                            "views/stages.css",
                            "views/users.css"]

        File.open(File.join(css_dir, 'views/all.css'), 'w') do |all_css|
            styles.each do |style|
              all_css.puts(File.read(File.join(css_dir, style)))
            end
        end
    %>
    <%= stylesheet_link_tag "views/all.css" %>
<% end %>


<!-- less-to-css -->
<% if use_compressed_js? %>
    <%= stylesheet_link_tag "css_sass/css_sass.css" %>
<% else %>
    <% styles = [
            "css_sass/base/mixins.css",
            "css_sass/base/reset-g9.css",
            "css_sass/base/sprites.css",
            "css_sass/base/variables.css",
            "css_sass/components/alerts.css",
            "css_sass/components/labels-badges.css",
            "css_sass/components/messages.css",
            "css_sass/components/navbar.css",
            "css_sass/components/pagination.css",
            "css_sass/components/treenav.css",
            "css_sass/components/wizard.css",
            "css_sass/gadgets/breadcrumb.css",
            "css_sass/gadgets/button-groups.css",
            "css_sass/gadgets/docked-toolbar.css",
            "css_sass/gadgets/dropdowns.css",
            "css_sass/gadgets/forms.css",
            "css_sass/gadgets/layouts.css",
            "css_sass/gadgets/modals.css",
            "css_sass/gadgets/popovers.css",
            "css_sass/gadgets/progress-bars.css",
            "css_sass/gadgets/scaffolding.css",
            "css_sass/gadgets/tabs.css",
            "css_sass/gadgets/tooltip.css",
            "css_sass/global/layout.css",
            "css_sass/global/reset.css",
            "css_sass/global/responsive.css",
            "css_sass/global/typography.css",
            "css_sass/go-pages/agent.css",
            "css_sass/go-pages/admin.css",
            "css_sass/go-pages/admin/templates.css",
            "css_sass/go-pages/vsm.css",
            "css_sass/go-pages/history-panel.css",
            "css_sass/go-pages/pipeline.css"
        ]

        File.open(File.join(css_dir, 'css_sass/css_sass.css'), 'w') do |all_css|
            styles.each do |style|
                all_css.puts(File.read(File.join(css_dir, style)))
            end
        end
    %>
<%= stylesheet_link_tag "css_sass/css_sass.css" %>
<% end %>
<% if use_compressed_js? %>
    <%= javascript_include_tag url_for_path('/compressed/all.js') %>
<% else %>
    <%= javascript_include_tag "gadget_toolkit" %>
<% end -%>
<script type="text/javascript">
    gadgets.util.registerOnLoadHandler(function() {
      var contentUrl = '<%= pipeline_status_gadget_content_url -%>';
      var pipelineName = new gadgets.Prefs().getString("pipelineName");
      var requestUrl = contentUrl + "?pipeline_name=" + pipelineName;
      
      gadget_toolkit.makeOAuthRequest(requestUrl, { 
        view:             "gadget_content",
        gadgetTitle:      '<%=l.string("GADGET_NAME_PIPELINE_STATUS")%>',
        serviceName:      '<%=l.string("GO")%>',
        autoRefresh:      new gadgets.Prefs().getBool("autoRefresh"),
        refreshInterval:  60000
      });
    });
</script>
<div id="gadget_content">
</div>
        ]]>
    </Content>
</Module>